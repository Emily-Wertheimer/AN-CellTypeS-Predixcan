## get started
ml R/4.2.0-foss-2020b
install.packages('data.table')
install.packages('tidyverse')
library(data.table)
library(tidyverse)

## read in spredix results and tissues
spredix_software_path <-'/home/ekw28/project/sPrediXcan_AN/software'
path_predix_results_adiposeSub <-sprintf('/home/ekw28/project/sPrediXcan_AN/results/AN_GWAS_2019__Adipose_Subcutaneous.GTExv8')
predix_results_adiposeSub <- as.data.frame(fread(path_predix_results_adiposeSub))
tissues <-read_lines('/home/ekw28/project/sPrediXcan_AN/GTEx_v8_elastic_net_copies/en_Adipose_Subcutaneous.txt')
tissues_nospaces <- gsub(' ', '',tissues)
path_feature <- '/gpfs/gibbs/pi/huckins/projects/GTEx/BMI/featureData_bytissue/Adipose-Subcutaneous_featureData.txt.gz'
all_features <- NULL
tissue_here <- 'en_Adipose_Subcutaneous.txt'
path_feature_here <- sprintf('/gpfs/gibbs/pi/huckins/projects/GTEx/BMI/featureData_bytissue/Adipose-Subcutaneous_featureData.txt.gz')
featuredt <- as.data.frame(fread(path_feature_here, header=T, sep="\t", quote = "",stringsAsFactors=F))
featuredt$tissue <- tissue_here
all_features <- rbind(all_features,featuredt)

## left join predixcan w/ features to get gene start location
toplot_annot <- left_join(predix_results_adiposeSub,unique(all_features[,c('Name','start','Chr')]), by=c('gene' = 'Name'))

## Paste gene start and chr 
toplot_annot$location <- paste(toplot_annot$Chr, toplot_annot$start, sep='.')

## find bonf sig
bonf_sig <- toplot_annot %>% dplyr::count() %>% mutate(bonf=.05/n) 

## plot spredix manhattan for tissue type ----- trouble shoot this!
plottingdir <- '/home/ekw28/project/sPrediXcan_AN/figures'
pdf(paste(plottingdir,'adipose_subcutaneous_spredix_GTEXv8_Manhattan.pdf', sep='_'), sep='/'), height=10, width=20)
ggplot(toplot_annot,aes(x = as.numeric(location), y = -log10(pvalue), color=as.factor(Chr))) + 
geom_point() + 
theme_classic(base_size=24) +
geom_hline(yintercept=bonf_sig, linetype='dashed', color='red') + 
scale_x_continuous(limits=c(1,23),breaks=seq(1.5,22.5), labels=seq(1,22)) + 
labs(x='Chromosome', y='-log10(p)')


